<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Pipeline Comercial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --border: #e5e7eb;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f3f4f6;
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .tab.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab:hover:not(.active) {
            background-color: #e5e7eb;
        }

        .dashboard {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .dashboard.active {
            display: block;
        }

        .dashboard-header {
            margin-bottom: 24px;
        }

        .dashboard-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dashboard-subtitle {
            color: var(--gray);
            font-size: 16px;
        }

        .filter-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            width: 100%;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #0da271;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .table-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            width: 250px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .atendimentos-table {
            width: 100%;
            border-collapse: collapse;
        }

        .atendimentos-table th {
            background-color: var(--light);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .atendimentos-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .atendimentos-table tr:hover {
            background-color: #f8fafc;
        }

        .atendimentos-table tr:last-child td {
            border-bottom: none;
        }

        .diretoria-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .diretoria-store {
            background-color: #6366f1;
        }

        .diretoria-homesphere {
            background-color: #10b981;
        }

        .diretoria-parcerias {
            background-color: #f59e0b;
        }

        .diretoria-ferrari {
            background-color: #ef4444;
        }

        .diretoria-diretoria {
            background-color: #8b5cf6;
        }

        .diretoria-sell {
            background-color: #06b6d4;
        }

        .tipo-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: #e5e7eb;
            color: var(--dark);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .metric-header .icon {
            width: 40px;
            height: 40px;
            background-color: var(--light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .metric-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .metric-content p {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 4px;
        }

        .metric-content strong {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-top: 8px;
        }

        .metric-content .info-text {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 4px;
        }

        .timeline-header {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
        }

        .timeline-container {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 20px;
            padding-bottom: 10px;
            margin-bottom: 30px;
            scroll-behavior: smooth;
        }

        .timeline-card {
            flex: 0 0 auto;
            width: 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .timeline-card h4 {
            font-size: 1rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-card h5 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .timeline-card ul {
            list-style: none;
            padding-left: 0;
            margin-top: 10px;
        }

        .timeline-card ul li {
            position: relative;
            padding-left: 20px;
            font-size: 0.9rem;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .timeline-card ul li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .chart-card h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            background-color: var(--light);
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tratativa-item {
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
            padding: 5px 8px;
            border-radius: 6px;
            margin: 2px 0;
        }

        .tratativa-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .tooltip {
            position: absolute;
            background-color: var(--dark);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            line-height: 1.4;
            max-width: 250px;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
        }

        .tooltip.show {
            opacity: 1;
            visibility: visible;
        }

        .tooltip::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid var(--dark);
        }

        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-range .filter-group {
            flex: 1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--success);
        }

        .notification.error {
            background-color: var(--danger);
        }

        .notification.warning {
            background-color: var(--warning);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--primary);
        }

        .error-message {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success-message {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .warning-message {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .filter-container {
                grid-template-columns: 1fr;
            }
            .timeline-card {
                width: 280px;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .charts-container {
                grid-template-columns: 1fr;
            }
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            .search-box {
                width: 100%;
            }
            .table-actions {
                justify-content: space-between;
            }
            .date-range {
                flex-direction: column;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">
            <i class="fas fa-chart-line"></i>
            <span>Pipeline Comercial</span>
        </div>
        <div class="tabs">
            <div class="tab active" data-target="resumo">Resumo da Semana</div>
            <div class="tab" data-target="resumo-mes">Resumo do Mês</div>
            <div class="tab" data-target="historico-mes">Histórico Mensal</div>
            <div class="tab" data-target="panorama-estoque">Panorama Estoque</div>
            <div class="tab" data-target="controle-atendimentos">Controle de Atendimentos</div>
            <div class="tab" data-target="tratativas">Pipeline de Tratativas</div>
        </div>
    </header>

    <div id="statusArea"></div>

    <div id="resumo" class="dashboard active">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-bullhorn" style="color: #f59e0b;"></i>
                Resumo da Semana
            </h1>
            <p class="dashboard-subtitle">Panorama de 29/09/25 a 05/10/25</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #3b82f6;"><i class="fas fa-door-open"></i></div>
                    <h3>Visitas</h3>
                </div>
                <div class="metric-content">
                    <p>Total de visitas:</p>
                    <strong id="totalVisitasSemana">8</strong>
                    <p class="info-text" id="infoVisitasSemana">Store: 6 / Homesphere: 2 / Ferrari: 0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #6366f1;"><i class="fas fa-user-friends"></i></div>
                    <h3>Indicações</h3>
                </div>
                <div class="metric-content">
                    <p>Total de indicações:</p>
                    <strong id="totalIndicacoesSemana">7</strong>
                    <p class="info-text" id="infoIndicacoesSemana">Store: 4 / Homesphere: 0 / Parcerias: 1 / Ferrari: 2</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #f59e0b;"><i class="fas fa-reply"></i></div>
                    <h3>Retornos</h3>
                </div>
                <div class="metric-content">
                    <p>Retornos na semana:</p>
                    <strong id="totalRetornosSemana">2</strong>
                    <p class="info-text" id="infoRetornosSemana">Store: 1 / Homesphere: 1 / Parcerias: 0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #ef4444;"><i class="fas fa-file-invoice-dollar"></i></div>
                    <h3>Propostas</h3>
                </div>
                <div class="metric-content">
                    <p>Propostas geradas:</p>
                    <strong>0</strong>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h4><i class="fas fa-chart-pie"></i> Distribuição por Diretoria</h4>
                <div class="chart-container">
                    <canvas id="chartDiretoriaSemana"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> Tipo de Atendimento</h4>
                <div class="chart-container">
                    <canvas id="chartTipoAtendimento"></canvas>
                </div>
            </div>
        </div>

        <h2 class="timeline-header">Origem dos Clientes</h2>
        <div class="timeline-container">
            <div class="timeline-card">
                <h4><i class="fas fa-map-marked-alt"></i> Visitas</h4>
                <h5>Origem das Visitas</h5>
                <p style="margin-bottom: 10px;">Vez: 8 atendimentos</p>
                <ul>
                    <li>Passagem → 4</li>
                    <li>Vizinho → 2</li>
                    <li>Instagram → 1</li>
                    <li>Jogo na quadra → 1</li>
                </ul>
            </div>
            <div class="timeline-card">
                <h4><i class="fas fa-user-check"></i> Indicações</h4>
                <h5>Origem das Indicações</h5>
                <ul>
                    <li>Carteira → 3</li>
                    <li>Folheto em rua → 3</li>
                    <li>Lead Online → 1</li>
                </ul>
            </div>
            <div class="timeline-card">
                <h4><i class="fas fa-reply"></i> Retornos</h4>
                <h5>Origem dos Retornos</h5>
                <ul>
                    <li>Retorno → 2</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="resumo-mes" class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-calendar-alt" style="color: #10b981;"></i>
                Resumo do Mês - <span id="mesAtualNome">OUTUBRO</span>
            </h1>
            <p class="dashboard-subtitle">QUADDRA LORENA - <span id="mesAtualSubtitle">Outubro/2025</span></p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #3b82f6;"><i class="fas fa-door-open"></i></div>
                    <h3>Visitas Espontâneas</h3>
                </div>
                <div class="metric-content">
                    <p>Total de visitas:</p>
                    <strong id="totalVisitasOutubro">0</strong>
                    <p class="info-text" id="infoVisitasOutubro">Store: 0 / Sell: 0 / Homesphere: 0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #6366f1;"><i class="fas fa-user-friends"></i></div>
                    <h3>Indicações Empresa</h3>
                </div>
                <div class="metric-content">
                    <p>Total de indicações:</p>
                    <strong id="totalIndicacoesOutubro">0</strong>
                    <p class="info-text" id="infoIndicacoesOutubro">Store: 0 / Sell: 0 / Home: 0 / Parcerias: 0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #f59e0b;"><i class="fas fa-reply"></i></div>
                    <h3>Retornos</h3>
                </div>
                <div class="metric-content">
                    <p>Retornos no mês:</p>
                    <strong id="totalRetornosOutubro">0</strong>
                    <p class="info-text" id="infoRetornosOutubro">Store: 0 / Sell: 0 / Home: 0 / Parcerias: 0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #10b981;"><i class="fas fa-chart-line"></i></div>
                    <h3>Total de Atendimentos</h3>
                </div>
                <div class="metric-content">
                    <p>Atendimentos totais:</p>
                    <strong id="totalGeralOutubro">0</strong>
                    <p class="info-text">Visitas + Indicações + Retornos</p>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h4><i class="fas fa-chart-pie"></i> Distribuição por Diretoria - <span id="chartTituloOutubro">Outubro</span></h4>
                <div class="chart-container">
                    <canvas id="chartDiretoriaOutubro"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> Tipo de Atendimento - <span id="chartTipoTituloOutubro">Outubro</span></h4>
                <div class="chart-container">
                    <canvas id="chartTipoAtendimentoOutubro"></canvas>
                </div>
            </div>
        </div>

        <h2 class="timeline-header" id="timelineTituloOutubro">Performance Outubro por Diretoria</h2>
        <div class="timeline-container" id="timelineOutubro">
            <div class="timeline-card loading">Carregando performance...</div>
        </div>
    </div>

    <div id="historico-mes" class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-history" style="color: #8b5cf6;"></i>
                Histórico Mensal - <span id="mesAnteriorNome">SETEMBRO</span>
            </h1>
            <p class="dashboard-subtitle">Relatório Mensal - <span id="mesAnteriorSubtitle">Setembro/2025</span></p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #3b82f6;"><i class="fas fa-door-open"></i></div>
                    <h3>Visitas Espontâneas</h3>
                </div>
                <div class="metric-content">
                    <p>Total de visitas:</p>
                    <strong id="totalVisitasSetembro">0</strong>
                    <p class="info-text" id="infoVisitasSetembro">Store: 0 / Sell: 0 / Homesphere: 0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #6366f1;"><i class="fas fa-user-friends"></i></div>
                    <h3>Indicações Empresa</h3>
                </div>
                <div class="metric-content">
                    <p>Total de indicações:</p>
                    <strong id="totalIndicacoesSetembro">0</strong>
                    <p class="info-text" id="infoIndicacoesSetembro">Store: 0 / Sell: 0 / Home: 0 / Diretoria: 0 / Parcerias: 0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #f59e0b;"><i class="fas fa-reply"></i></div>
                    <h3>Retornos</h3>
                </div>
                <div class="metric-content">
                    <p>Retornos no mês:</p>
                    <strong id="totalRetornosSetembro">0</strong>
                    <p class="info-text" id="infoRetornosSetembro">Store: 0 / Sell: 0 / Home: 0 / Parcerias: 0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="icon" style="color: #10b981;"><i class="fas fa-chart-line"></i></div>
                    <h3>Total de Atendimentos</h3>
                </div>
                <div class="metric-content">
                    <p>Atendimentos totais:</p>
                    <strong id="totalGeralSetembro">0</strong>
                    <p class="info-text">Visitas + Indicações + Retornos</p>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h4><i class="fas fa-chart-pie"></i> Distribuição por Diretoria - <span id="chartTituloSetembro">Setembro</span></h4>
                <div class="chart-container">
                    <canvas id="chartDiretoriaSetembro"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> Tipo de Atendimento - <span id="chartTipoTituloSetembro">Setembro</span></h4>
                <div class="chart-container">
                    <canvas id="chartTipoAtendimentoSetembro"></canvas>
                </div>
            </div>
        </div>

        <h2 class="timeline-header" id="timelineTituloSetembro">Performance Setembro por Diretoria</h2>
        <div class="timeline-container" id="timelineSetembro">
            <div class="timeline-card loading">Carregando performance...</div>
        </div>
    </div>

    <div id="panorama-estoque" class="dashboard">
        </div>

    <div id="controle-atendimentos" class="dashboard">
        </div>

    <div id="tratativas" class="dashboard">
        </div>
</div>

<script>
    // URL Fictícia para fins de demonstração. Substitua pela sua URL real do Google Sheets (exportado como CSV)
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1v.../pub?gid=0&single=true&output=csv';

    // CONSTANTES DE COLUNAS (Assumidas com base no seu dashboard)
    const COL_DATA = 0; // Coluna 1
    const COL_TIPO_VISITA = 1; // Coluna 2: Vez, Indicação, Retorno
    const COL_CORRETOR = 2; // Coluna 3
    const COL_GERENTE = 3; // Coluna 4
    const COL_DIRETORIA = 4; // Coluna 5: YUNY STORE, HOMESPHERE, PARCERIAS, etc.

    // VARIÁVEIS GLOBAIS DE ESTADO
    let atendimentosData = [];
    let atendimentosFiltrados = [];
    let atendimentosPaginados = [];
    let currentPage = 1;
    const rowsPerPage = 50;

    // VARIÁVEIS GLOBAIS DE GRÁFICOS (para destruição e recriação)
    let chartDiretoriaAtendimentos = null;
    let chartTipoAtendimentos = null;
    let chartDiretoriaSetembro = null;
    let chartTipoAtendimentoSetembro = null;
    let chartDiretoriaOutubro = null;
    let chartTipoAtendimentoOutubro = null;
    
    // Mapeamento de cores para consistência visual
    const CORES_DIRETORIA = {
        'YUNY STORE': '#6366f1',
        'HOMESPHERE': '#10b981',
        'PARCERIAS': '#f59e0b',
        'DIRETORIA': '#8b5cf6',
        'YUNY SELL': '#06b6d4',
        'FERRARI': '#ef4444',
        'Default': '#6b7280'
    };

    /**
     * UTILS
     */

    function showStatus(message, type = 'success') {
        const statusArea = document.getElementById('statusArea');
        statusArea.innerHTML = `<div class="${type}-message">${message}</div>`;
        setTimeout(() => statusArea.innerHTML = '', 5000);
    }

    function parseDate(dateStr) {
        if (!dateStr) return null;

        // Tenta DD/MM/AAAA ou DD-MM-AAAA
        const parts = dateStr.match(/(\d{1,2})[-/](\d{1,2})[-/](\d{4})/);
        if (parts) {
            const day = parseInt(parts[1], 10);
            const month = parseInt(parts[2], 10);
            const year = parseInt(parts[3], 10);
            return new Date(year, month - 1, day);
        }

        // Tenta AAAA-MM-DD (formato ISO)
        if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }
        return null;
    }

    function csvToJson(csv) {
        const lines = csv.split('\n');
        const result = [];
        
        // Assume que a primeira linha é o cabeçalho (desconsiderada)
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.length === 0) continue;

            // Usa regex para separar por vírgula, ignorando vírgulas dentro de aspas duplas
            const columns = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
            
            if (columns && columns.length > COL_DIRETORIA) { // Verifica se tem colunas suficientes
                const row = columns.map(col => col.replace(/^"|"$/g, '').trim());
                result.push(row);
            }
        }
        return result;
    }

    /**
     * LÓGICA DE DADOS E CÁLCULO DE MÉTRICAS
     */

    function carregarDadosPlanilha() {
        const loadingRow = document.getElementById('tabelaAtendimentos');
        loadingRow.innerHTML = `<tr><td colspan="5" class="loading"><i class="fas fa-spinner fa-spin"></i> Carregando dados da planilha...</td></tr>`;

        fetch(CSV_URL)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.status}`);
                }
                return response.text();
            })
            .then(csvText => {
                atendimentosData = csvToJson(csvText);
                
                // Inicializa os filtros e a tabela principal
                limparFiltros(); 
                
                // >>> PONTO DE AUTOMAÇÃO DE GRÁFICOS DINÂMICOS <<<
                inicializarDashboardsEstaticos(); 
                
                showStatus(`Dados carregados com sucesso! Total de ${atendimentosData.length} registros.`, 'success');
            })
            .catch(error => {
                console.error("Erro ao carregar dados da planilha:", error);
                loadingRow.innerHTML = `<tr><td colspan="5" class="error-message">Erro ao carregar dados: ${error.message}. Verifique a URL do CSV.</td></tr>`;
                showStatus('Falha ao carregar dados. Verifique o console para detalhes.', 'error');
            });
    }

    function calcularMetricas(data) {
        const metricas = {
            total: data.length,
            diretorias: {},
            tipos: {},
            visitas: { total: 0, diretorias: {} },
            indicacoes: { total: 0, diretorias: {} },
            retornos: { total: 0, diretorias: {} },
        };

        const diretoriasSet = new Set();
        const tiposSet = new Set();

        data.forEach(item => {
            const diretoria = item[COL_DIRETORIA] || 'Não Informado';
            const tipo = item[COL_TIPO_VISITA] || 'Não Informado';

            diretoriasSet.add(diretoria);
            tiposSet.add(tipo);

            // Contagem geral por diretoria e tipo
            metricas.diretorias[diretoria] = (metricas.diretorias[diretoria] || 0) + 1;
            metricas.tipos[tipo] = (metricas.tipos[tipo] || 0) + 1;

            // Contagem por Tipo de Visita (para os cards)
            if (tipo.toLowerCase() === 'vez') {
                metricas.visitas.total++;
                metricas.visitas.diretorias[diretoria] = (metricas.visitas.diretorias[diretoria] || 0) + 1;
            } else if (tipo.toLowerCase() === 'indicação') {
                metricas.indicacoes.total++;
                metricas.indicacoes.diretorias[diretoria] = (metricas.indicacoes.diretorias[diretoria] || 0) + 1;
            } else if (tipo.toLowerCase() === 'retorno') {
                metricas.retornos.total++;
                metricas.retornos.diretorias[diretoria] = (metricas.retornos.diretorias[diretoria] || 0) + 1;
            }
        });

        // Garantir que todas as diretorias estejam nas sub-métricas (para o info-text)
        metricas.diretoriasSet = Array.from(diretoriasSet);
        metricas.tiposSet = Array.from(tiposSet);

        return metricas;
    }

    function formatDiretoriaInfo(diretoriaMetrics, diretorias) {
        return diretorias.map(dir => {
            const count = diretoriaMetrics[dir] || 0;
            return `${dir.replace('YUNY ', '').replace('HOMESPHERE', 'Home').replace('PARCERIAS', 'Parcerias')}: ${count}`;
        }).join(' / ');
    }

    function updateMetrics(metricas, idSuffix) {
        // Atualiza Cards de Atendimentos
        document.getElementById(`totalVisitas${idSuffix}`).textContent = metricas.visitas.total;
        document.getElementById(`totalIndicacoes${idSuffix}`).textContent = metricas.indicacoes.total;
        document.getElementById(`totalRetornos${idSuffix}`).textContent = metricas.retornos.total;
        document.getElementById(`totalGeral${idSuffix}`).textContent = metricas.total;

        // Atualiza Info-text
        document.getElementById(`infoVisitas${idSuffix}`).textContent = formatDiretoriaInfo(metricas.visitas.diretorias, metricas.diretoriasSet);
        document.getElementById(`infoIndicacoes${idSuffix}`).textContent = formatDiretoriaInfo(metricas.indicacoes.diretorias, metricas.diretoriasSet);
        document.getElementById(`infoRetornos${idSuffix}`).textContent = formatDiretoriaInfo(metricas.retornos.diretorias, metricas.diretoriasSet);

        // Atualiza a Timeline (Simplificado para apenas as diretorias que tiveram atendimentos)
        const timelineContainer = document.getElementById(`timeline${idSuffix}`);
        timelineContainer.innerHTML = ''; // Limpa o conteúdo
        
        const diretoriasComPerformance = metricas.diretoriasSet.sort();

        diretoriasComPerformance.forEach(dir => {
            if (metricas.diretorias[dir] > 0) {
                const total = metricas.diretorias[dir];
                const visitas = metricas.visitas.diretorias[dir] || 0;
                const indicacoes = metricas.indicacoes.diretorias[dir] || 0;
                const retornos = metricas.retornos.diretorias[dir] || 0;

                const cor = CORES_DIRETORIA[dir] || CORES_DIRETORIA.Default;
                const nomeCurto = dir.includes('STORE') ? 'STORE' : (dir.includes('HOMESPHERE') ? 'HOMESPHERE' : dir);
                const icon = nomeCurto.includes('STORE') ? 'store-alt' : (nomeCurto.includes('HOME') ? 'home' : 'handshake');

                const cardHtml = `
                    <div class="timeline-card">
                        <h4><i class="fas fa-${icon}" style="color: ${cor};"></i> ${nomeCurto}</h4>
                        <h5>Performance do Mês</h5>
                        <ul>
                            <li>Visitas: ${visitas}</li>
                            <li>Indicações: ${indicacoes}</li>
                            <li>Retornos: ${retornos}</li>
                            <li>Total: ${total}</li>
                        </ul>
                    </div>
                `;
                timelineContainer.innerHTML += cardHtml;
            }
        });

        if (timelineContainer.innerHTML === '') {
             timelineContainer.innerHTML = `<div class="timeline-card"><p>Nenhum atendimento registrado no período.</p></div>`;
        }
    }

    /**
     * LÓGICA DE GRÁFICOS
     */

    function criarGrafico(ctx, chartType, label, dataLabels, dataValues, backgroundColors) {
        return new Chart(ctx, {
            type: chartType,
            data: {
                labels: dataLabels,
                datasets: [{
                    label: label,
                    data: dataValues,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: false,
                    }
                }
            }
        });
    }

    function inicializarGraficosMes(dados, idDiretoria, idTipo, idSuffix) {
        const metricas = calcularMetricas(dados);
        updateMetrics(metricas, idSuffix);
        
        // Dados para Gráfico de Diretoria (Pizza)
        const diretoriasLabels = Object.keys(metricas.diretorias);
        const diretoriasData = Object.values(metricas.diretorias);
        const diretoriasColors = diretoriasLabels.map(dir => CORES_DIRETORIA[dir] || CORES_DIRETORIA.Default);

        // Dados para Gráfico de Tipo de Atendimento (Barra)
        const tiposLabels = Object.keys(metricas.tipos);
        const tiposData = Object.values(metricas.tipos);
        const tiposColors = tiposLabels.map(() => 'rgba(59, 130, 246, 0.7)'); // Cor padrão para barra

        // Destruição de instâncias anteriores
        if (idSuffix === 'Setembro' && chartDiretoriaSetembro) chartDiretoriaSetembro.destroy();
        if (idSuffix === 'Setembro' && chartTipoAtendimentoSetembro) chartTipoAtendimentoSetembro.destroy();
        if (idSuffix === 'Outubro' && chartDiretoriaOutubro) chartDiretoriaOutubro.destroy();
        if (idSuffix === 'Outubro' && chartTipoAtendimentoOutubro) chartTipoAtendimentoOutubro.destroy();


        // Criação de novos gráficos
        const ctxDiretoria = document.getElementById(idDiretoria).getContext('2d');
        const ctxTipo = document.getElementById(idTipo).getContext('2d');
        
        const novoChartDiretoria = criarGrafico(ctxDiretoria, 'pie', 'Distribuição por Diretoria', diretoriasLabels, diretoriasData, diretoriasColors);
        const novoChartTipo = criarGrafico(ctxTipo, 'bar', 'Total de Atendimentos', tiposLabels, tiposData, tiposColors);
        
        // Atualiza variáveis globais de gráficos
        if (idSuffix === 'Setembro') {
            chartDiretoriaSetembro = novoChartDiretoria;
            chartTipoAtendimentoSetembro = novoChartTipo;
        } else if (idSuffix === 'Outubro') {
            chartDiretoriaOutubro = novoChartDiretoria;
            chartTipoAtendimentoOutubro = novoChartTipo;
        }

    }

    function inicializarDashboardsEstaticos() {
        if (atendimentosData.length === 0) return;

        // 1. Histórico Mensal - SETEMBRO (Mês 9)
        const dadosSetembro = atendimentosData.filter(item => {
            const dataItem = parseDate(item[COL_DATA]);
            // O mês no JS é 0-indexado. Setembro é 8. Assumimos o ano 2025 pelo contexto do HTML.
            return dataItem && dataItem.getMonth() === 8 && dataItem.getFullYear() === 2025; 
        });
        
        // Atualiza títulos para SETEMBRO
        document.getElementById('mesAnteriorNome').textContent = 'SETEMBRO';
        document.getElementById('mesAnteriorSubtitle').textContent = 'Setembro/2025';
        document.getElementById('chartTituloSetembro').textContent = 'Setembro';
        document.getElementById('chartTipoTituloSetembro').textContent = 'Setembro';
        document.getElementById('timelineTituloSetembro').textContent = 'Performance Setembro por Diretoria';

        inicializarGraficosMes(
            dadosSetembro, 
            'chartDiretoriaSetembro', 
            'chartTipoAtendimentoSetembro', 
            'Setembro'
        );

        // 2. Resumo do Mês - OUTUBRO (Mês 10)
        const dadosOutubro = atendimentosData.filter(item => {
            const dataItem = parseDate(item[COL_DATA]);
            // O mês no JS é 0-indexado. Outubro é 9. Assumimos o ano 2025 pelo contexto do HTML.
            return dataItem && dataItem.getMonth() === 9 && dataItem.getFullYear() === 2025; 
        });

        // Atualiza títulos para OUTUBRO
        document.getElementById('mesAtualNome').textContent = 'OUTUBRO';
        document.getElementById('mesAtualSubtitle').textContent = 'Outubro/2025';
        document.getElementById('chartTituloOutubro').textContent = 'Outubro';
        document.getElementById('chartTipoTituloOutubro').textContent = 'Outubro';
        document.getElementById('timelineTituloOutubro').textContent = 'Performance Outubro por Diretoria';

        inicializarGraficosMes(
            dadosOutubro, 
            'chartDiretoriaOutubro', 
            'chartTipoAtendimentoOutubro', 
            'Outubro'
        );

        // 3. Inicializa os gráficos que permaneceram estáticos (Semana, Estoque)
        inicializarGraficosSemana();
        inicializarGraficosEstoque();
    }

    /**
     * LÓGICA DO DASHBOARD (Aba Controle de Atendimentos)
     * (Funções mantidas/necessárias para a aba principal)
     */

    function aplicarFiltros() {
        const dataInicioStr = document.getElementById('filterDataInicio').value;
        const dataFimStr = document.getElementById('filterDataFim').value;
        const diretoria = document.getElementById('filterDiretoria').value;
        const tipo = document.getElementById('filterTipo').value;

        const dataInicio = parseDate(dataInicioStr);
        const dataFim = parseDate(dataFimStr);

        atendimentosFiltrados = atendimentosData.filter(item => {
            const itemDate = parseDate(item[COL_DATA]);
            const itemDiretoria = item[COL_DIRETORIA];
            const itemTipo = item[COL_TIPO_VISITA];

            let passaNoFiltro = true;

            // Filtro de Data
            if (dataInicio && itemDate < dataInicio) passaNoFiltro = false;
            if (dataFim && itemDate > dataFim) passaNoFiltro = false;

            // Filtro de Diretoria
            if (diretoria !== 'todas' && itemDiretoria !== diretoria) passaNoFiltro = false;

            // Filtro de Tipo
            if (tipo !== 'todos' && itemTipo !== tipo) passaNoFiltro = false;

            return passaNoFiltro;
        });

        // Recalcular métricas e gráficos do Controle de Atendimentos
        updateAtendimentosMetrics(atendimentosFiltrados);
        inicializarGraficosAtendimentos(atendimentosFiltrados);

        // Resetar paginação e popular tabela
        currentPage = 1;
        popularTabela();

        showStatus(`Filtros aplicados. ${atendimentosFiltrados.length} registros encontrados.`);
    }

    function updateAtendimentosMetrics(data) {
        const metricas = calcularMetricas(data);
        
        // Elementos da aba 'Controle de Atendimentos'
        document.getElementById('totalAtendimentos').textContent = metricas.total;
        document.getElementById('totalStore').textContent = metricas.diretorias['YUNY STORE'] || 0;
        document.getElementById('totalHomesphere').textContent = metricas.diretorias['HOMESPHERE'] || 0;
        document.getElementById('totalParcerias').textContent = metricas.diretorias['PARCERIAS'] || 0;
    }

    function inicializarGraficosAtendimentos(dados) {
        const metricas = calcularMetricas(dados);

        // Gráfico de Diretoria (Pie)
        const diretoriasLabels = Object.keys(metricas.diretorias);
        const diretoriasData = Object.values(metricas.diretorias);
        const diretoriasColors = diretoriasLabels.map(dir => CORES_DIRETORIA[dir] || CORES_DIRETORIA.Default);

        if (chartDiretoriaAtendimentos) chartDiretoriaAtendimentos.destroy();
        const ctxDiretoria = document.getElementById('chartDiretoriaAtendimentos').getContext('2d');
        chartDiretoriaAtendimentos = criarGrafico(ctxDiretoria, 'pie', 'Distribuição por Diretoria', diretoriasLabels, diretoriasData, diretoriasColors);

        // Gráfico de Tipo (Bar)
        const tiposLabels = Object.keys(metricas.tipos);
        const tiposData = Object.values(metricas.tipos);
        const tiposColors = tiposLabels.map(() => 'rgba(239, 68, 68, 0.7)');

        if (chartTipoAtendimentos) chartTipoAtendimentos.destroy();
        const ctxTipo = document.getElementById('chartTipoAtendimentos').getContext('2d');
        chartTipoAtendimentos = criarGrafico(ctxTipo, 'bar', 'Total de Atendimentos por Tipo', tiposLabels, tiposData, tiposColors);
    }
    
    // As outras funções (limparFiltros, popularTabela, mudarPagina, filtrarTabela, limparBusca, exportarParaCSV) e as inicializações de gráficos estáticos restantes (Semana e Estoque) devem ser mantidas/implementadas de acordo com o seu código original.

    // Apenas placeholders para as funções estáticas que restaram, para evitar erros:
    function inicializarGraficosSemana() { /* Lógica para Resumo da Semana */ }
    function inicializarGraficosEstoque() { /* Lógica para Panorama Estoque */ }
    function limparFiltros() { /* Lógica de Limpar Filtros */ }
    function popularTabela() { /* Lógica de Paginação e Tabela */ }
    function mudarPagina() { /* Lógica de Mudar Página */ }
    function filtrarTabela() { /* Lógica de Busca na Tabela */ }
    function limparBusca() { /* Lógica de Limpar Busca */ }
    function exportarParaCSV() { /* Lógica de Exportar CSV */ }
    // ... restante das funções do dashboard ...


    /**
     * INICIALIZAÇÃO
     */

    document.addEventListener('DOMContentLoaded', function() {
        // ... Lógica de tabs (mantida) ...
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(this.dataset.target).classList.add('active');
            });
        });

        // ... Lógica de Tooltips (mantida) ...
        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('tratativa-item') && e.target.hasAttribute('data-tooltip')) {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip show';
                tooltip.textContent = e.target.getAttribute('data-tooltip');
                document.body.appendChild(tooltip);
                
                const rect = e.target.getBoundingClientRect();
                tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                tooltip.style.top = (rect.bottom + 5) + 'px';
                
                e.target._currentTooltip = tooltip;
            }
        });

        document.addEventListener('mouseout', function(e) {
            if (e.target.classList.contains('tratativa-item') && e.target._currentTooltip) {
                e.target._currentTooltip.remove();
                e.target._currentTooltip = null;
            }
        });

        // Carregar dados da planilha ao iniciar o DOM
        carregarDadosPlanilha(); // Esta função agora chama inicializarDashboardsEstaticos() após o carregamento.
    });

</script>
</body>
</html>
